!function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("tslib"),e=require("./date_utils"),i=require("./svg_utils"),s=require("./bar"),o=require("./arrow"),n=require("./popup");require("./gantt.scss");var a={QUARTER_DAY:"Quarter Day",HALF_DAY:"Half Day",DAY:"Day",WEEK:"Week",MONTH:"Month",YEAR:"Year"},r=function(){function r(t,e,i){this.setup_wrapper(t),this.setup_options(i),this.setup_tasks(e),this.change_view_mode(),this.bind_events()}return r.prototype.setup_wrapper=function(t){var e,s;if("string"==typeof t&&(t=document.querySelector(t)),t instanceof HTMLElement)s=t,e=t.querySelector("svg");else{if(!(t instanceof SVGElement))throw new TypeError("FrappÃ© Gantt only supports usage of a string CSS selector, HTML DOM element or SVG DOM element for the 'element' parameter");e=t}e?(this.$svg=e,this.$svg.classList.add("gantt")):this.$svg=(0,i.createSVG)("svg",{append_to:s,class:"gantt"}),this.$container=document.createElement("div"),this.$container.classList.add("gantt-container"),this.$svg.parentElement.appendChild(this.$container),this.$container.appendChild(this.$svg),this.popup_wrapper=document.createElement("div"),this.popup_wrapper.classList.add("popup-wrapper"),this.$container.appendChild(this.popup_wrapper)},r.prototype.setup_options=function(e){var i={header_height:50,column_width:30,step:24,view_modes:(0,t.__spreadArray)([],Object.values(a),!0),bar_height:20,bar_corner_radius:3,arrow_curve:5,padding:18,view_mode:"Day",date_format:"YYYY-MM-DD",popup_trigger:"click",custom_popup_html:null,language:"en"};this.options=Object.assign({},i,e)},r.prototype.setup_tasks=function(t){this.tasks=t.map((function(t,i){if(t._start=e.default.parse(t.start),t._end=e.default.parse(t.end),e.default.diff(t._end,t._start,"year")>10&&(t.end=null),t._index=i,!t.start&&!t.end){var s=e.default.today();t._start=s,t._end=e.default.add(s,2,"day")}if(!t.start&&t.end&&(t._start=e.default.add(t._end,-2,"day")),t.start&&!t.end&&(t._end=e.default.add(t._start,2,"day")),e.default.get_date_values(t._end).slice(3).every((function(t){return 0===t}))&&(t._end=e.default.add(t._end,24,"hour")),t.start&&t.end||(t.invalid=!0),"string"==typeof t.dependencies||!t.dependencies){var o=[];t.dependencies&&(o=t.dependencies.split(",").map((function(t){return t.trim()})).filter((function(t){return t}))),t.dependencies=o}return t.id||(t.id=function(t){return t.name+"_"+Math.random().toString(36).slice(2,12)}(t)),t})),this.setup_dependencies()},r.prototype.setup_dependencies=function(){this.dependency_map={};for(var t=0,e=this.tasks;t<e.length;t++)for(var i=e[t],s=0,o=i.dependencies;s<o.length;s++){var n=o[s];this.dependency_map[n]=this.dependency_map[n]||[],this.dependency_map[n].push(i.id)}},r.prototype.refresh=function(t){this.setup_tasks(t),this.change_view_mode()},r.prototype.change_view_mode=function(t){void 0===t&&(t=this.options.view_mode),this.update_view_scale(t),this.setup_dates(),this.render(),this.trigger_event("view_change",[t])},r.prototype.update_view_scale=function(t){this.options.view_mode=t,t===a.DAY?(this.options.step=24,this.options.column_width=38):t===a.HALF_DAY?(this.options.step=12,this.options.column_width=38):t===a.QUARTER_DAY?(this.options.step=6,this.options.column_width=38):t===a.WEEK?(this.options.step=168,this.options.column_width=140):t===a.MONTH?(this.options.step=720,this.options.column_width=120):t===a.YEAR&&(this.options.step=8760,this.options.column_width=120)},r.prototype.setup_dates=function(){this.setup_gantt_dates(),this.setup_date_values()},r.prototype.setup_gantt_dates=function(){this.gantt_start=this.gantt_end=null;for(var t=0,i=this.tasks;t<i.length;t++){var s=i[t];(!this.gantt_start||s._start<this.gantt_start)&&(this.gantt_start=s._start),(!this.gantt_end||s._end>this.gantt_end)&&(this.gantt_end=s._end)}this.gantt_start=e.default.start_of(this.gantt_start,"day"),this.gantt_end=e.default.start_of(this.gantt_end,"day"),this.view_is([a.QUARTER_DAY,a.HALF_DAY])?(this.gantt_start=e.default.add(this.gantt_start,-7,"day"),this.gantt_end=e.default.add(this.gantt_end,7,"day")):this.view_is(a.MONTH)?(this.gantt_start=e.default.start_of(this.gantt_start,"year"),this.gantt_end=e.default.add(this.gantt_end,1,"year")):this.view_is(a.YEAR)?(this.gantt_start=e.default.add(this.gantt_start,-2,"year"),this.gantt_end=e.default.add(this.gantt_end,2,"year")):(this.gantt_start=e.default.add(this.gantt_start,-1,"month"),this.gantt_end=e.default.add(this.gantt_end,1,"month"))},r.prototype.setup_date_values=function(){this.dates=[];for(var t=null;null===t||t<this.gantt_end;)t=t?this.view_is(a.YEAR)?e.default.add(t,1,"year"):this.view_is(a.MONTH)?e.default.add(t,1,"month"):e.default.add(t,this.options.step,"hour"):e.default.clone(this.gantt_start),this.dates.push(t)},r.prototype.bind_events=function(){this.bind_grid_click(),this.bind_bar_events()},r.prototype.render=function(){this.clear(),this.setup_layers(),this.make_grid(),this.make_dates(),this.make_bars(),this.make_arrows(),this.map_arrows_on_bars(),this.set_width(),this.set_scroll_position()},r.prototype.setup_layers=function(){this.layers={};for(var t=0,e=["grid","date","arrow","progress","bar","details"];t<e.length;t++){var s=e[t];this.layers[s]=(0,i.createSVG)("g",{class:s,append_to:this.$svg})}},r.prototype.make_grid=function(){this.make_grid_background(),this.make_grid_rows(),this.make_grid_header(),this.make_grid_ticks(),this.make_grid_highlights()},r.prototype.make_grid_background=function(){var t=this.dates.length*this.options.column_width,e=this.options.header_height+this.options.padding+(this.options.bar_height+this.options.padding)*this.tasks.length;(0,i.createSVG)("rect",{x:0,y:0,width:t,height:e,class:"grid-background",append_to:this.layers.grid}),i.$.attr(this.$svg,{height:e+this.options.padding+100,width:"100%"})},r.prototype.make_grid_rows=function(){for(var t=(0,i.createSVG)("g",{append_to:this.layers.grid}),e=(0,i.createSVG)("g",{append_to:this.layers.grid}),s=this.dates.length*this.options.column_width,o=this.options.bar_height+this.options.padding,n=this.options.header_height+this.options.padding/2,a=0,r=this.tasks;a<r.length;a++)r[a],(0,i.createSVG)("rect",{x:0,y:n,width:s,height:o,class:"grid-row",append_to:t}),(0,i.createSVG)("line",{x1:0,y1:n+o,x2:s,y2:n+o,class:"row-line",append_to:e}),n+=this.options.bar_height+this.options.padding},r.prototype.make_grid_header=function(){var t=this.dates.length*this.options.column_width,e=this.options.header_height+10;(0,i.createSVG)("rect",{x:0,y:0,width:t,height:e,class:"grid-header",append_to:this.layers.grid})},r.prototype.make_grid_ticks=function(){for(var t=0,s=this.options.header_height+this.options.padding/2,o=(this.options.bar_height+this.options.padding)*this.tasks.length,n=0,r=this.dates;n<r.length;n++){var p=r[n],d="tick";this.view_is(a.DAY)&&1===p.getDate()&&(d+=" thick"),this.view_is(a.WEEK)&&p.getDate()>=1&&p.getDate()<8&&(d+=" thick"),this.view_is(a.MONTH)&&(p.getMonth()+1)%3==0&&(d+=" thick"),(0,i.createSVG)("path",{d:"M "+t+" "+s+" v "+o,class:d,append_to:this.layers.grid}),this.view_is(a.MONTH)?t+=e.default.get_days_in_month(p)*this.options.column_width/30:t+=this.options.column_width}},r.prototype.make_grid_highlights=function(){if(this.view_is(a.DAY)){var t=e.default.diff(e.default.today(),this.gantt_start,"hour")/this.options.step*this.options.column_width,s=this.options.column_width,o=(this.options.bar_height+this.options.padding)*this.tasks.length+this.options.header_height+this.options.padding/2;(0,i.createSVG)("rect",{x:t,y:0,width:s,height:o,class:"today-highlight",append_to:this.layers.grid})}},r.prototype.make_dates=function(){for(var t=0,e=this.get_dates_to_draw();t<e.length;t++){var s=e[t];if((0,i.createSVG)("text",{x:s.lower_x,y:s.lower_y,innerHTML:s.lower_text,class:"lower-text",append_to:this.layers.date}),s.upper_text){var o=(0,i.createSVG)("text",{x:s.upper_x,y:s.upper_y,innerHTML:s.upper_text,class:"upper-text",append_to:this.layers.date});o.getBBox().x2>this.layers.grid.getBBox().width&&o.remove()}}},r.prototype.get_dates_to_draw=function(){var t=this,e=null;return this.dates.map((function(i,s){var o=t.get_date_info(i,e,s);return e=i,o}))},r.prototype.get_date_info=function(t,i,s){i||(i=e.default.add(t,1,"year"));var o={"Quarter Day_lower":e.default.format(t,"HH",this.options.language),"Half Day_lower":e.default.format(t,"HH",this.options.language),Day_lower:t.getDate()!==i.getDate()?e.default.format(t,"D",this.options.language):"",Week_lower:t.getMonth()!==i.getMonth()?e.default.format(t,"D MMM",this.options.language):e.default.format(t,"D",this.options.language),Month_lower:e.default.format(t,"MMMM",this.options.language),Year_lower:e.default.format(t,"YYYY",this.options.language),"Quarter Day_upper":t.getDate()!==i.getDate()?e.default.format(t,"D MMM",this.options.language):"","Half Day_upper":t.getDate()!==i.getDate()?t.getMonth()!==i.getMonth()?e.default.format(t,"D MMM",this.options.language):e.default.format(t,"D",this.options.language):"",Day_upper:t.getMonth()!==i.getMonth()?e.default.format(t,"MMMM",this.options.language):"",Week_upper:t.getMonth()!==i.getMonth()?e.default.format(t,"MMMM",this.options.language):"",Month_upper:t.getFullYear()!==i.getFullYear()?e.default.format(t,"YYYY",this.options.language):"",Year_upper:t.getFullYear()!==i.getFullYear()?e.default.format(t,"YYYY",this.options.language):""},n={x:s*this.options.column_width,lower_y:this.options.header_height,upper_y:this.options.header_height-25},a={"Quarter Day_lower":4*this.options.column_width/2,"Quarter Day_upper":0,"Half Day_lower":2*this.options.column_width/2,"Half Day_upper":0,Day_lower:this.options.column_width/2,Day_upper:30*this.options.column_width/2,Week_lower:0,Week_upper:4*this.options.column_width/2,Month_lower:this.options.column_width/2,Month_upper:12*this.options.column_width/2,Year_lower:this.options.column_width/2,Year_upper:30*this.options.column_width/2};return{upper_text:o[this.options.view_mode+"_upper"],lower_text:o[this.options.view_mode+"_lower"],upper_x:n.x+a[this.options.view_mode+"_upper"],upper_y:n.upper_y,lower_x:n.x+a[this.options.view_mode+"_lower"],lower_y:n.lower_y}},r.prototype.make_bars=function(){var t=this;this.bars=this.tasks.map((function(e){var i=new s.default(t,e);return t.layers.bar.appendChild(i.group),i}))},r.prototype.make_arrows=function(){var t=this;this.arrows=[];for(var e=function(e){var s;s=e.dependencies.map((function(i){var s=t.get_task(i);if(s){var n=new o.default(t,t.bars[s._index],t.bars[e._index]);return t.layers.arrow.appendChild(n.element),n}})).filter(Boolean),i.arrows=i.arrows.concat(s)},i=this,s=0,n=this.tasks;s<n.length;s++){e(n[s])}},r.prototype.map_arrows_on_bars=function(){for(var t=function(t){t.arrows=e.arrows.filter((function(e){return e.from_task.task.id===t.task.id||e.to_task.task.id===t.task.id}))},e=this,i=0,s=this.bars;i<s.length;i++){t(s[i])}},r.prototype.set_width=function(){var t=this.$svg.getBoundingClientRect().width,e=this.$svg.querySelector(".grid .grid-row").getAttribute("width");t<e&&this.$svg.setAttribute("width",e)},r.prototype.set_scroll_position=function(){var t=this.$svg.parentElement;if(t){var i=e.default.diff(this.get_oldest_starting_date(),this.gantt_start,"hour")/this.options.step*this.options.column_width-this.options.column_width;t.scrollLeft=i}},r.prototype.bind_grid_click=function(){var t=this;i.$.on(this.$svg,this.options.popup_trigger,".grid-row, .grid-header",(function(){t.unselect_all(),t.hide_popup()}))},r.prototype.bind_bar_events=function(){var e=this,s=!1,o=0,n=!1,a=!1,r=null,p=[];this.bar_being_dragged=null,i.$.on(this.$svg,"mousedown",".bar-wrapper, .handle",(function(d,h){var _=i.$.closest(".bar-wrapper",h);h.classList.contains("left")?n=!0:h.classList.contains("right")?a=!0:h.classList.contains("bar-wrapper")&&(s=!0),_.classList.add("active"),o=d.offsetX,d.offsetY,r=_.getAttribute("data-id");var u=(0,t.__spreadArray)([r],e.get_all_dependent_tasks(r),!0);p=u.map((function(t){return e.get_bar(t)})),e.bar_being_dragged=r,p.forEach((function(t){var e=t.$bar;e.ox=e.getX(),e.oy=e.getY(),e.owidth=e.getWidth(),e.finaldx=0}))})),i.$.on(this.$svg,"mousemove",(function(t){if(s||n||a){var i=t.offsetX-o;t.offsetY,p.forEach((function(t){var o=t.$bar;o.finaldx=e.get_snap_position(i),n?r===t.task.id?t.update_bar_position({x:o.ox+o.finaldx,width:o.owidth-o.finaldx}):t.update_bar_position({x:o.ox+o.finaldx}):a?r===t.task.id&&t.update_bar_position({width:o.owidth+o.finaldx}):s&&t.update_bar_position({x:o.ox+o.finaldx})}))}})),document.addEventListener("mouseup",(function(t){(s||n||a)&&p.forEach((function(t){return t.group.classList.remove("active")})),s=!1,n=!1,a=!1})),i.$.on(this.$svg,"mouseup",(function(t){e.bar_being_dragged=null,p.forEach((function(t){t.$bar.finaldx&&(t.date_changed(),t.set_action_completed())}))})),this.bind_bar_progress()},r.prototype.bind_bar_progress=function(){var t=this,e=0,s=null,o=null,n=null,a=null;i.$.on(this.$svg,"mousedown",".handle.progress",(function(r,p){s=!0,e=r.offsetX,r.offsetY;var d=i.$.closest(".bar-wrapper",p).getAttribute("data-id");o=t.get_bar(d),n=o.$bar_progress,a=o.$bar,n.finaldx=0,n.owidth=n.getWidth(),n.min_dx=-n.getWidth(),n.max_dx=a.getWidth()-n.getWidth()})),i.$.on(this.$svg,"mousemove",(function(t){if(s){var a=t.offsetX-e;t.offsetY,a>n.max_dx&&(a=n.max_dx),a<n.min_dx&&(a=n.min_dx);var r=o.$handle_progress;i.$.attr(n,"width",n.owidth+a),i.$.attr(r,"points",o.get_progress_polygon_points()),n.finaldx=a}})),i.$.on(this.$svg,"mouseup",(function(){s=!1,n&&n.finaldx&&(o.progress_changed(),o.set_action_completed())}))},r.prototype.get_all_dependent_tasks=function(t){for(var e=this,i=[],s=[t];s.length;){var o=s.reduce((function(t,i){return t=t.concat(e.dependency_map[i])}),[]);i=i.concat(o),s=o.filter((function(t){return!s.includes(t)}))}return i.filter(Boolean)},r.prototype.get_snap_position=function(t){var e,i=t;return this.view_is(a.WEEK)?i-(e=t%(this.options.column_width/7))+(e<this.options.column_width/14?0:this.options.column_width/7):this.view_is(a.MONTH)?i-(e=t%(this.options.column_width/30))+(e<this.options.column_width/60?0:this.options.column_width/30):i-(e=t%this.options.column_width)+(e<this.options.column_width/2?0:this.options.column_width)},r.prototype.unselect_all=function(){(0,t.__spreadArray)([],this.$svg.querySelectorAll(".bar-wrapper"),!0).forEach((function(t){t.classList.remove("active")}))},r.prototype.view_is=function(t){var e=this;return"string"==typeof t?this.options.view_mode===t:!!Array.isArray(t)&&t.some((function(t){return e.options.view_mode===t}))},r.prototype.get_task=function(t){return this.tasks.find((function(e){return e.id===t}))},r.prototype.get_bar=function(t){return this.bars.find((function(e){return e.task.id===t}))},r.prototype.show_popup=function(t){this.popup||(this.popup=new n.default(this.popup_wrapper,this.options.custom_popup_html)),this.popup.show(t)},r.prototype.hide_popup=function(){this.popup&&this.popup.hide()},r.prototype.trigger_event=function(t,e){this.options["on_"+t]&&this.options["on_"+t].apply(null,e)},r.prototype.get_oldest_starting_date=function(){return this.tasks.map((function(t){return t._start})).reduce((function(t,e){return e<=t?e:t}))},r.prototype.clear=function(){this.$svg.innerHTML=""},r}();exports.default=r,r.VIEW_MODE=a}();
